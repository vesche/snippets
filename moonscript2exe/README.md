# moonscript2exe

This is a process to turn a [MoonScript](http://moonscript.org/) source code file into a standalone executable.

First, let's make a simple MoonScript program:
```moon
--- hello.moon
--- moonscript2exe example <3

print "Hello, world!"
```

Next, we'll use `moonc` to compile MoonScript to [Lua](http://www.lua.org/):
```
$ moon hello.moon
Hello, world!
$ moonc hello.moon 
Built hello.moon
$ cat hello.lua 
return print("Hello, world!")
```

Now we can use `luac` to translate our Lua code into a binary file that can later loaded and executed.
```
$ luac hello.lua
$ file luac.out 
luac.out: Lua bytecode, version 5.1
$ xxd luac.out 
00000000: 1b4c 7561 5100 0104 0804 0800 0b00 0000  .LuaQ...........
00000010: 0000 0000 4068 656c 6c6f 2e6c 7561 0000  ....@hello.lua..
00000020: 0000 0000 0000 0000 0002 0205 0000 0005  ................
00000030: 0000 0041 4000 001d 0000 011e 0000 001e  ...A@...........
00000040: 0080 0002 0000 0004 0600 0000 0000 0000  ................
00000050: 7072 696e 7400 040e 0000 0000 0000 0048  print..........H
00000060: 656c 6c6f 2c20 776f 726c 6421 0000 0000  ello, world!....
00000070: 0005 0000 0001 0000 0001 0000 0001 0000  ................
00000080: 0001 0000 0001 0000 0000 0000 0000 0000  ................
00000090: 00
```

The [bin2c](http://lua-users.org/wiki/BinToCee) utility can be used to convert our `luac.out` binary file to a C char string that can be embedded in a C program:
```
$ lua bin2c.lua luac.out > code.c
```

Nice, here's our little C char string we can use now!
```c
/* code automatically generated by bin2c -- DO NOT EDIT */
{
/* #include'ing this file in a C program is equivalent to calling
  if (luaL_loadfile(L,"luac.out")==0) lua_pcall(L, 0, 0, 0); 
*/
/* luac.out */
static const unsigned char B1[]={
 27, 76,117, 97, 81,  0,  1,  4,  8,  4,  8,  0, 11,  0,  0,  0,  0,  0,  0,  0,
 64,104,101,108,108,111, 46,108,117, 97,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,
  0,  2,  2,  5,  0,  0,  0,  5,  0,  0,  0, 65, 64,  0,  0, 29,  0,  0,  1, 30,
  0,  0,  0, 30,  0,128,  0,  2,  0,  0,  0,  4,  6,  0,  0,  0,  0,  0,  0,  0,
112,114,105,110,116,  0,  4, 14,  0,  0,  0,  0,  0,  0,  0, 72,101,108,108,111,
 44, 32,119,111,114,108,100, 33,  0,  0,  0,  0,  0,  5,  0,  0,  0,  1,  0,  0,
  0,  1,  0,  0,  0,  1,  0,  0,  0,  1,  0,  0,  0,  1,  0,  0,  0,  0,  0,  0,
  0,  0,  0,  0,  0,
};

 if (luaL_loadbuffer(L,(const char*)B1,sizeof(B1),"luac.out")==0) lua_pcall(L, 0, 0, 0);
}
```

Using a few functions from the  [Lua auxiliary library](https://www.lua.org/manual/5.2/manual.html#5) we can include our generated `code.c` into some C source code:
```c
/* main.c */

#include <stdlib.h>
#include <stdio.h>
#include "lua.h"
#include "lauxlib.h"
#include "lualib.h"

int main(int argc, char *argv[]) {
  int i;
  lua_State *L = luaL_newstate();
  luaL_openlibs(L);
  lua_newtable(L);
  for (i = 0; i < argc; i++) {
    lua_pushnumber(L, i);
    lua_pushstring(L, argv[i]);
    lua_rawset(L, -3);
  }
  lua_setglobal(L, "arg");
#include "code.c"
  lua_close(L);
  return 0;
}
```

Finally, we can compile `main.c` into an executable and run it!
```
$ gcc -I/usr/include/lua5.1 -o main main.c -llua5.1 -lm
$ file main
main: ELF 64-bit LSB shared object, x86-64, version 1 (SYSV), dynamically linked, interpreter /lib64/ld-linux-x86-64.so.2, for GNU/Linux 2.6.32, BuildID[sha1]=03238192f11a658abbd7ced8951a3c44ff2637ca, not stripped
$ ./main
Hello, world!
```

Note that in order to compile `main.c` you need liblua: `apt-get install liblua5.1-dev`